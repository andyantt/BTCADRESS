<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>BTC 地址交易查询 & 导出 Excel</title>

  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #fafafa;
    }
    h1 {
      margin-bottom: 10px;
    }
    textarea {
      width: 100%;
      height: 120px;
      font-family: monospace;
      margin-bottom: 10px;
    }
    button {
      padding: 10px 18px;
      font-size: 14px;
      margin-right: 10px;
      cursor: pointer;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: left;
    }
    th {
      background: #eee;
    }
    .hint {
      color: #666;
      font-size: 13px;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>

<h1>BTC 地址交易查询</h1>
<div class="hint">
  每行一个 BTC 地址（支持 1 / 3 / bc1 开头），数据来源：Blockstream Esplora API
</div>

<textarea id="addresses" placeholder="bc1qxxxxxx&#10;1Axxxxx&#10;3Fxxxxx"></textarea>

<button onclick="query()">查询</button>
<button onclick="exportExcel()">导出 Excel</button>

<table id="resultTable">
  <thead>
    <tr>
      <th>地址</th>
      <th>时间 (UTC)</th>
      <th>TxID</th>
      <th>转入 BTC</th>
      <th>转出 BTC</th>
      <th>手续费 BTC</th>
      <th>当前地址余额 BTC</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const API_BASE = "https://blockstream.info/api";
let allRows = [];

function satToBtc(sat) {
  return (sat / 1e8).toFixed(8);
}

async function fetchJSON(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error("API 请求失败");
  return res.json();
}

async function query() {
  const tbody = document.querySelector("#resultTable tbody");
  tbody.innerHTML = "";
  allRows = [];

  const addresses = document
    .getElementById("addresses")
    .value
    .split("\n")
    .map(a => a.trim())
    .filter(a => a);

  for (const address of addresses) {
    // 余额
    const info = await fetchJSON(`${API_BASE}/address/${address}`);
    const balanceSat =
      info.chain_stats.funded_txo_sum -
      info.chain_stats.spent_txo_sum;
    const balanceBtc = satToBtc(balanceSat);

    // 交易（只取已确认，分页）
    let lastTxid = null;
    while (true) {
      const url = lastTxid
        ? `${API_BASE}/address/${address}/txs/chain/${lastTxid}`
        : `${API_BASE}/address/${address}/txs/chain`;

      const txs = await fetchJSON(url);
      if (txs.length === 0) break;

      for (const tx of txs) {
        let inSat = 0;
        let outSat = 0;

        for (const vout of tx.vout) {
          if (vout.scriptpubkey_address === address) {
            inSat += vout.value;
          }
        }

        for (const vin of tx.vin) {
          if (
            vin.prevout &&
            vin.prevout.scriptpubkey_address === address
          ) {
            outSat += vin.prevout.value;
          }
        }

        const time = tx.status.confirmed
          ? new Date(tx.status.block_time * 1000).toISOString()
          : "";

        const row = {
          地址: address,
          时间_UTC: time,
          TxID: tx.txid,
          转入_BTC: satToBtc(inSat),
          转出_BTC: satToBtc(outSat),
          手续费_BTC: satToBtc(tx.fee),
          当前余额_BTC: balanceBtc
        };

        allRows.push(row);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${address}</td>
          <td>${time}</td>
          <td style="font-family:monospace">${tx.txid}</td>
          <td>${satToBtc(inSat)}</td>
          <td>${satToBtc(outSat)}</td>
          <td>${satToBtc(tx.fee)}</td>
          <td>${balanceBtc}</td>
        `;
        tbody.appendChild(tr);
      }

      lastTxid = txs[txs.length - 1].txid;
      await new Promise(r => setTimeout(r, 200)); // 防限速
    }
  }

  alert("查询完成");
}

function exportExcel() {
  if (allRows.length === 0) {
    alert("没有数据可导出");
    return;
  }

  const ws = XLSX.utils.json_to_sheet(allRows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "BTC交易记录");

  XLSX.writeFile(wb, "btc_address_report.xlsx");
}
</script>

</body>
</html>
